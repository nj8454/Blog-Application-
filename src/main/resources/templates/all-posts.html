<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymleaf.org/extras/spring-security" lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>My Blog Application</title>
    <style>
        :root { --gap: 24px; --muted:#666; --border:#ddd; }
        body { font-family: system-ui, Arial, sans-serif; margin: 32px; }
        header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 24px; }
        h1 { margin:0; font-size: 36px; }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
        .card { border: 1px solid var(--border); padding: 16px; border-radius: 6px; background: #fff; }
        .meta { color: var(--muted); font-size: 0.9rem; margin: 6px 0 10px; }
        .tags { margin-top: 12px; color:#0a7; }
        .excerpt { margin: 8px 0 0; line-height: 1.4; }
        .card a { color: inherit; text-decoration: none; }
        .card a:hover { text-decoration: underline; }

        .toolbar { display:flex; gap:6px; align-items:right; }
        .toolbar input { padding:8px 10px; width:60px; }
        .toolbar select { padding:8px 10px; }

        .pager { display:flex; justify-content:space-between; margin-top: 24px; color:#333; }

        .searchbar { display:inline-flex; align-items:right; gap:6px; }
        .searchbar input[type="search"] {
            padding:8px 10px; width:260px;
            border:1px solid var(--border); border-radius:8px;
        }
        .searchbar button {
            padding:8px 12px;
            border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer;
        }
        .searchbar button:hover { background:#f5f5f5; }

        .dropdown { position:relative; display:inline-block; }
        .dropdown-toggle {
            padding:4px 6px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer;
        }
        #tags-dd-toggle { position:absolute; opacity:0; pointer-events:none; }
        .dropdown-menu {
            position:absolute; top:110%; left:0; z-index:10;
            min-width:60px; max-height:150px; overflow:auto;
            padding:2px; border:1px solid var(--border); border-radius:8px; background:#fff;
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            display:none;
        }
        #tags-dd-toggle:checked + label + .dropdown-menu { display:block; }
        .checkbox-row { display:flex; align-items:center; gap:2px; margin:4px 0; }
        .dd-actions { display:flex; gap:2px; justify-content:flex-end; margin-top:2px; }
        .dd-actions button {
            padding:2px 4px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer;
        }
        .dd-actions button:hover { background:#f5f5f5; }

        #authors-dd-toggle { position:absolute; opacity:0; pointer-events:none; }
        .dropdown-menu {
            position:absolute; top:110%; left:0; z-index:10;
            min-width:100px; max-height:150px; overflow:auto;
            padding:2px; border:1px solid var(--border); border-radius:8px; background:#fff;
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            display:none;
        }
        #authors-dd-toggle:checked + label + .dropdown-menu { display:block; }
        .checkbox-row { display:flex; align-items:center; gap:2px; margin:4px 0; }
        .dd-actions { display:flex; gap:2px; justify-content:flex-end; margin-top:2px; }
        .dd-actions button {
            padding:2px 4px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer;
        }
        .dd-actions button:hover { background:#f5f5f5; }
        .filters-disabled { opacity:.6; pointer-events:none; }
    </style>
</head>
<body>
<header>
    <h1>My Blog Application</h1>
    <div class="toolbar">
        <form th:action="@{/post/search}" method="get" class="searchbar">
            <input type="search" name="key" placeholder="Search" th:value="${key}"/>
            <button type="submit">Search</button>
        </form>

        <form th:action="@{/post/search}" method="get"
              style="display:inline-flex; gap:8px; align-items:center;">
            <input type="hidden" name="oldkey" th:value="${oldkey}"/>

            <div class="dropdown">
                <input type="checkbox" id="authors-dd-toggle"/>
                <label for="authors-dd-toggle" class="dropdown-toggle">Authors</label>
                <div class="dropdown-menu">
                    <div th:each="a : ${authors}" class="checkbox-row">
                        <input type="checkbox"
                               name="authors"
                               th:id="${'author_' + a}"
                               th:value="${a}"
                               th:attr="checked=${selectedAuthors != null
                               and selectedAuthors.contains(a)} ? 'checked' : null"/>
                        <label th:for="${'author_' + a}" th:text="${a}">author</label>
                    </div>
                    <div class="dd-actions">
                        <label for="authors-dd-toggle" class="dropdown-toggle">Close</label>
                        <button type="submit">Apply</button>
                    </div>
                </div>
            </div>

            <input type="datetime-local" name="from"/>
            <input type="datetime-local" name="to"/>

            <div class="dropdown">
                <input type="checkbox" id="tags-dd-toggle"/>
                <label for="tags-dd-toggle" class="dropdown-toggle">Tags</label>
                <div class="dropdown-menu">
                    <div th:each="t : ${allTags}" class="checkbox-row">
                        <input type="checkbox"
                               name="tags"
                               th:id="${'tag_' + t}"
                               th:value="${t}"
                               th:attr="checked=${selectedTags != null
                               and selectedTags.contains(t)} ? 'checked' : null"/>
                        <label th:for="${'tag_' + t}" th:text="${t}">tag</label>
                    </div>
                    <div class="dd-actions">
                        <label for="tags-dd-toggle" class="dropdown-toggle" style="padding:6px 10px;">Close</label>
                        <button type="submit">Apply</button>
                    </div>
                </div>
            </div>
            <select name="order" th:value="${order}">
                <option value="desc">Newest first</option>
                <option value="asc">Oldest first</option>
            </select>
            <button type="submit">Apply</button>
        </form>
        <div sec:authorize="hasAnyRole('AUTHOR', 'ADMIN')">
            <form th:action="@{/create}" method="get" style="margin-top:12px;">
                <button type="submit">
                    Create Blog
                </button>
            </form>
        </div>
    </div>
    <span sec:authorize="isAnonymous()">
        <a th:href="@{/login}" style="margin-left:12px;">Login</a>
    </span>
    <div sec:authorize="isAuthenticated()">
        <form th:action="@{/logout}" method="post" style="display:inline;">
            <button type="submit">Logout</button>
        </form>
    </div>
</header>

<div class="grid">
    <div th:each="p : ${posts}" class="card">
        <a th:href="@{'/post/' + ${p.id}}">
            <h2 th:text="${p.title}">Title</h2>
        </a>
        <div class="meta">
            <span th:text="${p.author}">Author</span>,
            <span th:text="${#temporals.format(p.createdAt, 'dd/MM/yyyy')}">18/08/2020</span>
        </div>
        <div class="tags" th:if="${p.tags}">
            Tags:
            <span th:text="${#strings.listJoin(p.tags, ', ')}">tag1, tag2</span>
        </div>
        <p class="excerpt" th:text="${p.excerpt}">Short excerpt...</p>
    </div>
</div>

<nav class="pagination">
    <!-- Prev -->
    <a th:if="${!page.first}"
       th:href="@{/post/search(
        start=${prevStart},
        order=${order},
        key=${key},
        from=${from},
        to=${to},
        authors=${selectedAuthors},
        tags=${selectedTags}
      )}">Prev</a>
    <span th:unless="${!page.first}">Prev</span>

    <span th:each="p : ${#numbers.sequence(0, page.totalPages - 1)}">
    <a th:if="${p != page.number}"
       th:href="@{/post/search(
        start=${(p-1)*limit + 1},
        order=${order},
        key=${key},
        from=${from},
        to=${to},
        authors=${selectedAuthors},
        tags=${selectedTags}
      )}"
       th:text="${p + 1}">1</a>
    <span th:unless="${p != page.number}" class="current" th:text="${p + 1}">1</span>
  </span>

    <!-- Next -->
    <a th:if="${!page.last}"
       th:href="@{/post/search(
        start=${nextStart},
        order=${order},
        key=${key},
        from=${from},
        to=${to},
        authors=${selectedAuthors},
        tags=${selectedTags}
      )}">Next</a>
    <span th:unless="${!page.last}">Next</span>
</nav>
<p class="range">
    Showing
    <span th:text="${page.number * page.size + 1}">1</span>
    -
    <span th:text="${(page.number + 1) * page.size > page.totalElements
    ? page.totalElements : (page.number + 1) * page.size}">10</span>
    of <span th:text="${page.totalElements}">0</span>
</p>
</body>
</html>
